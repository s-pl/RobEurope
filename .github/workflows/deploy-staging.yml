name: Deploy Backend — Staging

on:
  push:
    branches: [develop]
    paths:
      - "backend/**"
      - "docker-compose.yml"
      - "docker-compose.staging.yml"
      - "docker/mysql/init.sql"

# Solo un deploy de staging a la vez; si llega otro commit, cancela el anterior
concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.api.robeurope.samuelponce.es

    steps:
      - name: Deploy backend to staging via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key:      ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "──────────────────────────────────"
            echo "  RobEurope — Staging Deploy"
            echo "  Commit: ${{ github.sha }}"
            echo "──────────────────────────────────"

            # ── 1. Actualizar código ──────────────────────────────
            cd /opt/robeurope-staging
            git fetch origin develop
            git reset --hard origin/develop
            echo "✓ Código actualizado"

            # ── 2. Asegurar que la infraestructura está arriba ────
            docker compose -p robeurope-staging \
              -f docker-compose.yml \
              -f docker-compose.staging.yml \
              --profile prod \
              up -d mysql redis
            echo "✓ MySQL y Redis arriba"

            # ── 3. Build de la imagen del backend ─────────────────
            docker compose -p robeurope-staging \
              -f docker-compose.yml \
              -f docker-compose.staging.yml \
              --profile prod \
              build backend
            echo "✓ Imagen construida"

            # ── 4. Reiniciar solo el backend (sin tocar DB) ───────
            docker compose -p robeurope-staging \
              -f docker-compose.yml \
              -f docker-compose.staging.yml \
              --profile prod \
              up -d --no-deps backend
            echo "✓ Backend reiniciado"

            # ── 5. Esperar a que el backend responda ──────────────
            echo "Esperando a que el backend esté listo..."
            for i in $(seq 1 15); do
              if docker compose -p robeurope-staging \
                   -f docker-compose.yml \
                   -f docker-compose.staging.yml \
                   --profile prod \
                   exec -T backend wget -qO- http://localhost:85/api/health 2>/dev/null; then
                echo "✓ Backend saludable"
                break
              fi
              if [ "$i" -eq 15 ]; then
                echo "✗ Backend no respondió a tiempo"
                docker compose -p robeurope-staging \
                  -f docker-compose.yml \
                  -f docker-compose.staging.yml \
                  --profile prod \
                  logs --tail 30 backend
                exit 1
              fi
              sleep 3
            done

            # ── 6. Migraciones ────────────────────────────────────
            docker compose -p robeurope-staging \
              -f docker-compose.yml \
              -f docker-compose.staging.yml \
              --profile prod \
              exec -T backend node scripts/run-migrations.js
            echo "✓ Migraciones aplicadas"

            echo ""
            echo "✅ Staging desplegado correctamente"
            echo "   Commit: ${{ github.sha }}"
