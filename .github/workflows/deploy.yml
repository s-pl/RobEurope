name: Deploy to Production

on:
  push:
    branches:
      - main

# Evita deploys simultáneos; cancela el anterior si hay uno en curso
concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: SSH Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # ── 1. Checkout (solo para tener el SHA en los logs) ─────
      - name: Checkout
        uses: actions/checkout@v4

      # ── 2. Configurar clave SSH ───────────────────────────────
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      # ── 3. Deploy vía SSH (inline, sin script servidor) ───────
      - name: Deploy
        env:
          SSH_KEY_PATH: ~/.ssh/deploy_key
          REMOTE: ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          SSH_CMD="ssh -i $SSH_KEY_PATH -o StrictHostKeyChecking=no -o ConnectTimeout=15 $REMOTE"

          $SSH_CMD bash -s << 'REMOTE_SCRIPT'
            set -euo pipefail
            DEPLOY_PATH="/opt/robeurope"

            cd "$DEPLOY_PATH"

            echo "[deploy] git pull..."
            git pull origin main

            echo "[deploy] escribiendo deploy-info.json..."
            cat > "$DEPLOY_PATH/backend/deploy-info.json" << JSON
          {
            "deployed_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "$(git rev-parse HEAD)",
            "branch": "$(git rev-parse --abbrev-ref HEAD)",
            "triggered_by": "github-actions"
          }
          JSON

            echo "[deploy] docker compose build (prod)..."
            sudo docker compose -f "$DEPLOY_PATH/docker-compose.yml" --profile prod build

            echo "[deploy] docker compose up (prod)..."
            sudo docker compose -f "$DEPLOY_PATH/docker-compose.yml" --profile prod up -d

            echo "[deploy] migraciones..."
            sudo docker compose -f "$DEPLOY_PATH/docker-compose.yml" --profile prod exec -T backend sh -c "node scripts/run-migrations.js" || true

            echo "[deploy] ✓ Deploy completado"
          REMOTE_SCRIPT

      # ── 4. Limpiar clave privada ──────────────────────────────
      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
