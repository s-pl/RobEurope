name: Deploy Backend — Production

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "docker-compose.yml"
      - "docker/mysql/init.sql"

# En producción NO cancelamos deploys en curso — dejamos que acabe el anterior
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.robeurope.samuelponce.es

    steps:
      - name: Deploy backend to production via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key:      ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "──────────────────────────────────"
            echo "  RobEurope — Production Deploy"
            echo "  Commit: ${{ github.sha }}"
            echo "──────────────────────────────────"

            # ── 1. Actualizar código ──────────────────────────────
            cd /opt/robeurope
            git fetch origin main
            git reset --hard origin/main
            echo "✓ Código actualizado"

            # ── 2. Asegurar que la infraestructura está arriba ────
            docker compose -p robeurope-prod \
              --profile prod \
              up -d mysql redis
            echo "✓ MySQL y Redis arriba"

            # ── 3. Build de la imagen del backend ─────────────────
            docker compose -p robeurope-prod \
              --profile prod \
              build backend
            echo "✓ Imagen construida"

            # ── 4. Reiniciar solo el backend (sin tocar DB) ───────
            docker compose -p robeurope-prod \
              --profile prod \
              up -d --no-deps backend
            echo "✓ Backend reiniciado"

            # ── 5. Esperar a que el backend responda ──────────────
            echo "Esperando a que el backend esté listo..."
            for i in $(seq 1 20); do
              if docker compose -p robeurope-prod \
                   --profile prod \
                   exec -T backend wget -qO- http://localhost:85/api/health 2>/dev/null; then
                echo "✓ Backend saludable"
                break
              fi
              if [ "$i" -eq 20 ]; then
                echo "✗ Backend no respondió a tiempo — revisando logs..."
                docker compose -p robeurope-prod \
                  --profile prod \
                  logs --tail 40 backend
                exit 1
              fi
              sleep 4
            done

            # ── 6. Migraciones ────────────────────────────────────
            docker compose -p robeurope-prod \
              --profile prod \
              exec -T backend node scripts/run-migrations.js
            echo "✓ Migraciones aplicadas"

            # ── 7. Limpiar imágenes antiguas ──────────────────────
            docker image prune -f --filter "label=com.docker.compose.project=robeurope-prod" 2>/dev/null || true

            echo ""
            echo "✅ Producción desplegada correctamente"
            echo "   Commit: ${{ github.sha }}"
