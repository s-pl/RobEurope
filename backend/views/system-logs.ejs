<%- include('partials/header') %>

<section class="page-header">
  <div>
    <p class="page-eyebrow"><%= t('logs.eyebrow') %></p>
    <h2 class="page-title"><%= t('logs.title') %></h2>
  </div>
  <p class="page-description"><%= t('logs.description') %></p>
</section>

<div class="charts-container">
  <section class="chart-wrapper">
    <div class="chart-head">
      <p class="chart-label"><%= t('logs.chart.activityLabel') %></p>
      <h3 class="chart-title"><%= t('logs.chart.activityTitle') %></h3>
    </div>
    <svg id="actionsChart"></svg>
  </section>

  <section class="chart-wrapper">
    <div class="chart-head">
      <p class="chart-label"><%= t('logs.chart.entitiesLabel') %></p>
      <h3 class="chart-title"><%= t('logs.chart.entitiesTitle') %></h3>
    </div>
    <svg id="entitiesChart"></svg>
  </section>
</div>

<section class="filters-panel">
  <h3 style="margin:0"><%= t('logs.filters.title') %></h3>
  <div class="filters-grid">
    <div style="grid-column: 1 / -1;">
      <label for="searchLog"><%= t('logs.filters.searchLabel') %></label>
      <input type="text" id="searchLog" placeholder="<%= t('logs.filters.searchPlaceholder') %>" />
    </div>
    <div>
      <label for="actionFilter"><%= t('logs.filters.actionLabel') %></label>
      <select id="actionFilter">
        <option value=""><%= t('logs.filters.actionAll') %></option>
        <option value="CREATE"><%= t('logs.actions.CREATE') %></option>
        <option value="UPDATE"><%= t('logs.actions.UPDATE') %></option>
        <option value="DELETE"><%= t('logs.actions.DELETE') %></option>
        <option value="LOGIN"><%= t('logs.actions.LOGIN') %></option>
        <option value="LOGOUT"><%= t('logs.actions.LOGOUT') %></option>
        <option value="REGISTER"><%= t('logs.actions.REGISTER') %></option>
      </select>
    </div>
    <div>
      <label class="sr-only" for="resetLogFilters"><%= t('actions.resetFilters') %></label>
      <button id="resetLogFilters" class="btn btn-outline" type="button" onclick="resetLogFilters()"><%= t('actions.resetFilters') %></button>
    </div>
  </div>
</section>

<div class="table-container">
  <table role="grid">
    <thead>
      <tr>
        <th><%= t('logs.table.headers.time') %></th>
        <th><%= t('logs.table.headers.user') %></th>
        <th><%= t('logs.table.headers.action') %></th>
        <th><%= t('logs.table.headers.entity') %></th>
        <th><%= t('logs.table.headers.entityId') %></th>
        <th><%= t('logs.table.headers.ip') %></th>
        <th><%= t('logs.table.headers.details') %></th>
      </tr>
    </thead>
    <tbody id="logsTableBody">
      <% logs.forEach(log => { %>
        <tr class="log-row" data-action="<%= log.action %>" data-search="<%= (log.user ? log.user.username + ' ' + log.user.email : 'system').toLowerCase() %>">
          <td style="font-size: 0.8rem;">
            <%= new Date(log.created_at).toLocaleString(locale || 'es-ES') %>
          </td>
          <td>
            <% if (log.user) { %>
              <strong><%= log.user.username %></strong><br/>
              <span style="font-size: 0.8rem; color: #94a3b8;"><%= log.user.email %></span>
            <% } else { %>
              <span style="color: #94a3b8;"><%= t('logs.table.systemUser') %></span>
            <% } %>
          </td>
          <td>
            <% 
              let actionClass = 'action-badge-create';
              if (log.action === 'UPDATE') actionClass = 'action-badge-update';
              else if (log.action === 'DELETE') actionClass = 'action-badge-delete';
              else if (log.action === 'LOGIN') actionClass = 'action-badge-login';
              else if (log.action === 'LOGOUT') actionClass = 'action-badge-logout';
            %>
            <span class="<%= actionClass %>">
              <%= t({ phrase: 'logs.actions.' + log.action, defaultValue: log.action }) %>
            </span>
          </td>
          <td><%= log.entity_type || t('common.notAvailable') %></td>
          <td style="font-size: 0.8rem; font-family: monospace;"><%= log.entity_id || t('common.notAvailable') %></td>
          <td style="font-size: 0.8rem;"><%= log.ip_address || t('common.notAvailable') %></td>
          <td style="font-size: 0.8rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
            <% if (log.details) { %>
              <%= log.details.substring(0, 50) %>...
            <% } else { %>
              <%= t('common.notAvailable') %>
            <% } %>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- PaginaciÃ³n -->
<div class="pagination" style="margin-top: 1.5rem;">
  <% if (currentPage > 1) { %>
    <a href="/admin/logs?page=1" class="btn btn-outline"><%= t('logs.pagination.first') %></a>
    <a href="/admin/logs?page=<%= currentPage - 1 %>" class="btn btn-outline"><%= t('logs.pagination.prev') %></a>
  <% } %>

  <span class="page-counter"><%= t('logs.pagination.summary', { current: currentPage, total: totalPages, count: totalLogs }) %></span>

  <% if (currentPage < totalPages) { %>
    <a href="/admin/logs?page=<%= currentPage + 1 %>" class="btn btn-outline"><%= t('logs.pagination.next') %></a>
    <a href="/admin/logs?page=<%= totalPages %>" class="btn btn-outline"><%= t('logs.pagination.last') %></a>
  <% } %>
</div>

<%- include('partials/footer') %>
