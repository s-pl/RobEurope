<%- include('partials/header') %>

<section class="page-header">
  <div>
    <p class="page-eyebrow"><%= t('dashboard.eyebrow') %></p>
    <h2 class="page-title"><%= t('dashboard.title') %></h2>
  </div>
  <p class="page-description"><%= t('dashboard.description') %></p>
</section>

<div class="stats-grid">
  <article class="stat">
    <h3><%= t('dashboard.stats.users') %></h3>
    <p><%= stats.users %></p>
  </article>
  <article class="stat">
    <h3><%= t('dashboard.stats.competitions') %></h3>
    <p><%= stats.competitions %></p>
  </article>
  <article class="stat">
    <h3><%= t('dashboard.stats.posts') %></h3>
    <p><%= stats.posts %></p>
  </article>
  <article class="stat">
    <h3><%= t('dashboard.stats.registrations') %></h3>
    <p><%= stats.registrations %></p>
  </article>
</div>

<div class="system-status-grid">
  <article class="stat" id="sys-cpu">
    <h3><%= t('dashboard.system.cpu') %></h3>
    <p><%= t('common.loading') %></p>
  </article>
  <article class="stat" id="sys-mem">
    <h3><%= t('dashboard.system.memory') %></h3>
    <p><%= t('common.loading') %></p>
  </article>
  <article class="stat" id="sys-mysql">
    <h3><%= t('dashboard.system.mysql') %></h3>
    <p><%= t('common.loading') %></p>
  </article>
  <article class="stat" id="sys-redis">
    <h3><%= t('dashboard.system.redis') %></h3>
    <p><%= t('common.loading') %></p>
    <div id="redis-extra" class="stat-note"></div>
    <p class="stat-note"><a class="subtle-link" href="/admin/redis"><%= t('dashboard.redis.link') %></a></p>
  </article>
  <article class="stat" id="sys-sessions">
    <h3><%= t('dashboard.system.sessions') %></h3>
    <p><%= t('common.loading') %></p>
  </article>
</div>

<div class="charts-container">
  <section class="chart-wrapper">
    <div class="chart-head">
      <p class="chart-label"><%= t('dashboard.charts.rolesLabel') %></p>
      <h3 class="chart-title"><%= t('dashboard.charts.rolesTitle') %></h3>
    </div>
    <svg id="userRoleChart"></svg>
  </section>

  <section class="chart-wrapper">
    <div class="chart-head">
      <p class="chart-label"><%= t('dashboard.charts.registrationLabel') %></p>
      <h3 class="chart-title"><%= t('dashboard.charts.registrationTitle') %></h3>
    </div>
    <svg id="registrationChart"></svg>
  </section>

  <section class="chart-wrapper wide">
    <div class="chart-head">
      <p class="chart-label"><%= t('dashboard.charts.timelineLabel') %></p>
      <h3 class="chart-title"><%= t('dashboard.charts.timelineTitle') %></h3>
    </div>
    <svg id="timelineChart"></svg>
  </section>
</div>

<script>
  async function updateSystemStats() {
    try {
      const res = await fetch('/admin/api/stats');
      const data = await res.json();
      
      if (data.system) {
        document.querySelector('#sys-cpu p').textContent = data.system.cpu.load.toFixed(1) + '%';
        
        const memUsed = (data.system.memory.active / 1024 / 1024 / 1024).toFixed(2);
        const memTotal = (data.system.memory.total / 1024 / 1024 / 1024).toFixed(2);
        document.querySelector('#sys-mem p').textContent = `${memUsed} / ${memTotal} GB`;
        
        const mysqlEl = document.querySelector('#sys-mysql p');
        mysqlEl.textContent = window.__('status.' + (data.system.mysql === 'up' ? 'up' : 'down'));
        mysqlEl.style.color = data.system.mysql === 'up' ? 'green' : 'red';

        const redisEl = document.querySelector('#sys-redis p');
        redisEl.textContent = window.__('status.' + (data.system.redis === 'up' ? 'up' : 'down'));
        redisEl.style.color = data.system.redis === 'up' ? 'green' : 'red';

        // Fetch Redis overview for extra info
        try {
          const rov = await (await fetch('/admin/api/redis/overview', { credentials: 'include' })).json();
          if (rov && !rov.error) {
            const extra = document.getElementById('redis-extra');
            extra.textContent = window.__('dashboard.redis.extra', {
              keys: rov.dbsize,
              memory: rov.info?.used_memory_human || '-',
              clients: rov.info?.connected_clients || '-'
            });
          }
        } catch (_) {}
      }

      // Fetch extended overview from new API
      try {
        const over = await (await fetch('/api/admin/stats/overview', { credentials: 'include' })).json();
        if (over?.activeSessions != null) {
          document.querySelector('#sys-sessions p').textContent = over.activeSessions;
        }
      } catch (e) {
        // ignore
      }
    } catch (e) {
      console.error('Error fetching system stats', e);
    }
  }
  
  // Initial load
  updateSystemStats();
  // Refresh every 10s
  setInterval(updateSystemStats, 10000);
</script>

<%- include('partials/footer') %>