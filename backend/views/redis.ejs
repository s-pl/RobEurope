<%- include('partials/header') %>

<style>
  .redis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.25rem;
  }
  .redis-keys-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px dashed var(--border);
    border-radius: var(--radius);
  }
  .redis-key-item {
    padding: 0.6rem 0.85rem;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
  }
  .redis-key-item:last-child { border-bottom: none; }
  .redis-key-item:hover {
    background: rgba(37, 99, 235, 0.08);
  }
  .redis-controls label {
    display: flex;
    flex-direction: column;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--muted-foreground);
  }
  .redis-controls input {
    width: 180px;
  }
  .redis-status {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }
  .redis-pre {
    background: rgba(15, 23, 42, 0.04);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 1rem;
    min-height: 220px;
    max-height: 360px;
    overflow: auto;
  }
</style>

<section class="page-header">
  <div>
    <p class="page-eyebrow"><%= t('redis.eyebrow') %></p>
    <h2 class="page-title"><%= t('redis.title') %></h2>
  </div>
  <p class="page-description"><%= t('redis.description') %></p>
</section>

<article class="card" id="overview">
  <h3 style="margin-top:0;"><%= t('redis.overview.title') %></h3>
  <p id="ov-content" class="stat-note"><%= t('redis.overview.loading') %></p>
</article>

<section class="filters-panel redis-controls">
  <div class="table-actions" style="flex-wrap: wrap; gap: 1rem;">
    <label>
      <span><%= t('redis.controls.pattern') %></span>
      <input id="pattern" type="text" value="*" />
    </label>
    <label>
      <span><%= t('redis.controls.count') %></span>
      <input id="count" type="number" min="1" max="500" value="50" />
    </label>
    <button id="scanBtn" class="btn btn-primary"><%= t('redis.controls.scan') %></button>
  </div>
  <div class="redis-status">
    <span id="cursorInfo" class="stat-note"></span>
    <span id="errorInfo" class="stat-note" style="color: var(--danger);"></span>
  </div>
</section>

<div class="redis-grid">
  <article class="card">
    <div class="chart-head">
      <h3 class="chart-title"><%= t('redis.keys.title') %></h3>
    </div>
    <div id="keys" class="redis-keys-list"></div>
    <div class="table-actions" style="margin-top:1rem;">
      <button id="prevCursor" class="btn btn-outline btn-sm"><%= t('redis.keys.prev') %></button>
      <button id="nextCursor" class="btn btn-outline btn-sm"><%= t('redis.keys.next') %></button>
    </div>
  </article>
  <article class="card">
    <div class="chart-head">
      <h3 class="chart-title"><%= t('redis.details.title') %></h3>
    </div>
    <div id="keyMeta" class="stat-note"></div>
    <pre id="keyValue" class="redis-pre"></pre>
    <button id="deleteBtn" class="btn btn-danger btn-sm" style="display:none"><%= t('redis.details.delete') %></button>
  </article>
</div>

<script>
  const translate = (key, vars) => (window.__ ? window.__(key, vars || {}) : key);
  const cursorInfoEl = document.getElementById('cursorInfo');
  const errorInfoEl = document.getElementById('errorInfo');
  const keysContainer = document.getElementById('keys');
  const keyMetaEl = document.getElementById('keyMeta');
  const keyValueEl = document.getElementById('keyValue');
  const deleteBtn = document.getElementById('deleteBtn');
  const csrfMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';

  let cursor = 0;
  let keysPages = [];
  let currentPageIndex = -1;
  let selectedKey = null;

  const setError = (message) => {
    errorInfoEl.textContent = translate('redis.controls.error', { message });
  };

  async function scan() {
    try {
      const pattern = document.getElementById('pattern').value || '*';
      const count = document.getElementById('count').value || '50';
      const url = `/admin/api/redis/keys?pattern=${encodeURIComponent(pattern)}&count=${encodeURIComponent(count)}&cursor=${cursor}`;
      const res = await fetch(url, { credentials: 'include' });
      if (!res.ok) {
        const text = (await res.text().catch(() => '')) || res.statusText;
        setError(`${text} (${res.status})`);
        alert(translate('redis.alerts.scanFailed'));
        return;
      }
      const data = await res.json();
      cursor = Number(data.cursor) || 0;
      const keys = Array.isArray(data.keys) ? data.keys : [];
      keysPages.push(keys);
      currentPageIndex = keysPages.length - 1;
      renderKeys(keys);
      cursorInfoEl.textContent = translate('redis.controls.cursor', { value: cursor });
      errorInfoEl.textContent = '';
    } catch (error) {
      setError(error.message || 'scan');
      alert(translate('redis.alerts.scanFailed'));
    }
  }

  function renderKeys(keys) {
    keysContainer.innerHTML = '';
    if (!keys || keys.length === 0) {
      keysContainer.textContent = translate('redis.keys.empty');
      return;
    }
    keys.forEach((k) => {
      const div = document.createElement('div');
      div.className = 'redis-key-item';
      div.textContent = k;
      div.onclick = () => selectKey(k);
      keysContainer.appendChild(div);
    });
  }

  async function selectKey(key) {
    try {
      selectedKey = key;
      const res = await fetch(`/admin/api/redis/key/${encodeURIComponent(key)}`, { credentials: 'include' });
      if (!res.ok) {
        const text = (await res.text().catch(() => '')) || res.statusText;
        setError(`${text} (${res.status})`);
        alert(translate('redis.alerts.getFailed'));
        return;
      }
      const data = await res.json();
      keyMetaEl.textContent = translate('redis.details.meta', { type: data.type, ttl: data.ttl });
      keyValueEl.textContent = formatValue(data.value);
      deleteBtn.style.display = 'inline-flex';
      deleteBtn.onclick = deleteSelected;
      errorInfoEl.textContent = '';
    } catch (error) {
      setError(error.message || 'key');
      alert(translate('redis.alerts.getFailed'));
    }
  }

  function formatValue(val) {
    try { return JSON.stringify(val, null, 2); } catch (err) { return String(val); }
  }

  async function deleteSelected() {
    if (!selectedKey) return;
    if (!confirm(translate('redis.confirmDelete', { key: selectedKey }))) return;
    try {
      const res = await fetch(`/admin/api/redis/key/${encodeURIComponent(selectedKey)}`, {
        method: 'DELETE',
        credentials: 'include',
        headers: { 'CSRF-Token': csrfToken }
      });
      if (!res.ok) {
        const text = (await res.text().catch(() => '')) || res.statusText;
        setError(`${text} (${res.status})`);
        alert(translate('redis.alerts.deleteFailed'));
        return;
      }
      alert(translate('redis.alerts.deleted'));
      const current = keysPages[currentPageIndex] || [];
      keysPages[currentPageIndex] = current.filter((k) => k !== selectedKey);
      renderKeys(keysPages[currentPageIndex]);
      keyMetaEl.textContent = '';
      keyValueEl.textContent = '';
      deleteBtn.style.display = 'none';
      selectedKey = null;
      errorInfoEl.textContent = '';
    } catch (error) {
      setError(error.message || 'delete');
      alert(translate('redis.alerts.deleteFailed'));
    }
  }

  document.getElementById('scanBtn').onclick = () => {
    cursor = 0;
    keysPages = [];
    currentPageIndex = -1;
    selectedKey = null;
    keyMetaEl.textContent = '';
    keyValueEl.textContent = '';
    deleteBtn.style.display = 'none';
    renderKeys([]);
    cursorInfoEl.textContent = '';
    scan();
  };
  document.getElementById('nextCursor').onclick = () => { scan(); };
  document.getElementById('prevCursor').onclick = () => {
    if (currentPageIndex > 0) {
      currentPageIndex -= 1;
      renderKeys(keysPages[currentPageIndex]);
      cursorInfoEl.textContent = translate('redis.controls.cursor', { value: cursor });
    }
  };

  (async function loadOverview() {
    const overviewEl = document.getElementById('ov-content');
    try {
      const rov = await (await fetch('/admin/api/redis/overview', { credentials: 'include' })).json();
      if (rov && !rov.error) {
        overviewEl.textContent = translate('redis.overview.summary', {
          ping: rov.ping,
          keys: rov.dbsize,
          memory: rov.info?.used_memory_human || '-',
          clients: rov.info?.connected_clients || '-',
          uptime: rov.info?.uptime_in_seconds || '-'
        });
      } else {
        overviewEl.textContent = translate('redis.overview.error', { message: rov?.error || 'unknown' });
      }
    } catch (error) {
      overviewEl.textContent = translate('redis.overview.error', { message: error.message || 'network' });
    }
  })();

  scan();
</script>

<%- include('partials/footer') %>
