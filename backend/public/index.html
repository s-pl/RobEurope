<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>API Tester</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Inter, Segoe UI, Arial, sans-serif;
      margin: 20px;
    }
    input, button, select, textarea {
      font: inherit;
      padding: 8px;
      margin: 4px;
    }
    .section {
      border: 1px solid #ddd;
      padding: 12px;
      margin: 8px 0;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    h3, h4 {
      margin-bottom: 6px;
    }
    /* helper and error styles */
    .help-text{font-size:12px;color:#666;margin-left:4px}
    .help-icon{font-weight:bold;margin-left:6px;color:#999;cursor:help}
    .field-error{color:#b00020;font-size:12px;margin-top:4px}
    .input-error{outline:1px solid #b00020}
    .toast-container{position:fixed;right:20px;top:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
    .toast{padding:10px 14px;border-radius:6px;color:white;box-shadow:0 2px 8px rgba(0,0,0,0.15);opacity:0;transform:translateY(-8px);transition:all .25s}
    .toast.visible{opacity:1;transform:translateY(0)}
    .toast.info{background:#2b6cb0}
    .toast.success{background:#2f855a}
    .toast.error{background:#c53030}
  </style>
</head>
<body>
  <div id="toastContainer" class="toast-container" aria-live="polite"></div>

  <div class="section">
    <h3>Connection</h3>
    <div class="row">
      <input id="baseUrl" placeholder="Base URL (e.g. http://localhost:85)" style="min-width:300px">
      <input id="authToken" placeholder="Auth token (optional)" style="min-width:300px">
    </div>
  </div>

  <div class="section">
    <h3>Auth</h3>
    <div class="row">
      <input id="loginEmail" placeholder="email for login" />
      <input id="loginPassword" type="password" placeholder="password for login" />
      <button onclick="login()">Login</button>
      <button onclick="document.getElementById('authToken').value=''">Clear Token</button>
    </div>
    <div class="row">
      <input id="regUsername" placeholder="username (register)" />
      <input id="regEmail" placeholder="email (register)" />
      <input id="regPassword" type="password" placeholder="password (register)" />
      <input id="regFirst" placeholder="first_name" />
      <input id="regLast" placeholder="last_name" />
      <button onclick="register()">Register</button>
    </div>
  </div>

  <div class="section">
    <h3>Resources</h3>
    <div class="row">
      <button onclick="apiGet('/health')">GET /health</button>
      <button onclick="apiGet('/countries')">GET /countries</button>
      <button onclick="apiGet('/users')">GET /users</button>
      <button onclick="apiGet('/streams')">GET /streams</button>
      <button onclick="apiGet('/posts')">GET /posts</button>
      <button onclick="apiGet('/competitions')">GET /competitions</button>
      <button onclick="apiGet('/teams')">GET /teams</button>
      <button onclick="apiGet('/registrations')">GET /registrations</button>
      <button onclick="apiGet('/sponsors')">GET /sponsors</button>
      <button onclick="apiGet('/team-members')">GET /team-members</button>
      <button onclick="apiGet('/notifications')">GET /notifications</button>
    </div>

    <h4>Get by ID</h4>
    <div class="row">
      <input id="resourceId" placeholder="resource id" />
      <select id="resourceSelect">
        <option value="posts">posts</option>
        <option value="competitions">competitions</option>
        <option value="teams">teams</option>
        <option value="registrations">registrations</option>
        <option value="sponsors">sponsors</option>
        <option value="streams">streams</option>
        <option value="team-members">team-members</option>
        <option value="notifications">notifications</option>
        <option value="users">users</option>
        <option value="countries">countries</option>
      </select>
      <button onclick="getById()">GET /:id</button>
    </div>

    <h4>Create Post</h4>
    <div class="row">
      <input id="postTitle" placeholder="title (required)" />
      <input id="postContent" placeholder="content (required)" />
      <input id="postAuthorId" placeholder="author_id (optional UUID)" />
      <input id="postMedia" placeholder="media_urls (comma-separated)" />
      <button onclick="createPost()">POST /posts</button>
    </div>

    <h4>Create Competition</h4>
    <div class="row">
      <input id="compTitle" placeholder="title (required)" />
      <input id="compSlug" placeholder="slug (required)" />
      <input id="compDescription" placeholder="description" />
      <input id="compCountryId" placeholder="country_id (optional)" />
      <input id="compRegistrationStart" type="date" placeholder="registration_start" />
      <input id="compRegistrationEnd" type="date" placeholder="registration_end" />
      <input id="compStartDate" type="date" placeholder="start_date" />
      <input id="compEndDate" type="date" placeholder="end_date" />
      <input id="compRulesUrl" placeholder="rules_url" />
      <input id="compStreamUrl" placeholder='stream_url (JSON or URL)' />
      <button onclick="createCompetition()">POST /competitions</button>
    </div>

    <h4>Create Team</h4>
    <div class="row">
      <input id="teamName" placeholder="name (required)" />
      <input id="teamCountryId" placeholder="country_id (optional)" />
      <input id="teamCity" placeholder="city" />
      <input id="teamInstitution" placeholder="institution" />
      <input id="teamLogo" placeholder="logo_url" />
      <input id="teamSocialLinks" placeholder='social_links (JSON, e.g. {"twitter":"@x"})' />
      <input id="teamCreatedBy" placeholder="created_by_user_id (UUID)" />
      <button onclick="createTeam()">POST /teams</button>
    </div>

    <h4>Create Registration</h4>
    <div class="row">
      <input id="regTeamId" placeholder="team_id (required)" />
      <input id="regCompetitionId" placeholder="competition_id (required)" />
      <select id="regStatus">
        <option value="pending">pending</option>
        <option value="approved">approved</option>
        <option value="rejected">rejected</option>
      </select>
      <input id="regDate" type="date" placeholder="registration_date" />
      <button onclick="createRegistration()">POST /registrations</button>
    </div>

    <h4>Team Members</h4>
    <div class="row">
      <input id="tmTeamId" placeholder="team_id (required)" />
      <input id="tmUserId" placeholder="user_id (required UUID)" />
      <input id="tmRole" placeholder="role (required)" />
      <input id="tmJoinedAt" type="date" placeholder="joined_at" />
      <input id="tmLeftAt" type="date" placeholder="left_at" />
      <button onclick="createTeamMember()">POST /team-members</button>
    </div>

    <h4>Notifications</h4>
    <div class="row">
      <label>User: 
        <select id="noteUserId" style="min-width:200px">
          <option value="">-- select user --</option>
        </select>
      </label>
      <input id="noteTitle" placeholder="title (required)" />
      <label>Type:
        <select id="noteType">
          <option value="">-- select type --</option>
          <option value="registration_team_status">registration_team_status</option>
          <option value="team_invite">team_invite</option>
          <option value="mention">mention</option>
        </select>
      </label>
      <input id="noteMessage" placeholder="message (required)" />
      <button onclick="createNotification()">POST /notifications</button>
      <input id="noteId" placeholder="notification id" />
      <button onclick="markNotificationRead()">PUT /notifications/:id (mark read)</button>
      <button onclick="deleteNotification()">DELETE /notifications/:id</button>
    </div>

    <h4>Countries / Sponsors</h4>
    <div class="row">
      <input id="countryName" placeholder="country name (required)" />
      <input id="countryCode" placeholder="country code (required)" />
      <input id="countryFlag" placeholder="flag_emoji" />
      <button onclick="createCountry()">POST /countries</button>
      <label>Or select country: 
        <select id="countrySelect" style="min-width:180px">
          <option value="">-- select country --</option>
        </select>
      </label>
      <input id="sponsorName" placeholder="sponsor name (required)" />
      <input id="sponsorLogo" placeholder="logo_url" />
      <input id="sponsorWebsite" placeholder="website_url" />
      <button onclick="createSponsor()">POST /sponsors</button>
    </div>

    <h4>Streams (auth required)</h4>
    <div class="row">
      <input id="streamTitle" placeholder="stream title (required)" />
      <input id="streamDescription" placeholder="description" />
      <select id="streamPlatform">
        <option value="twitch">twitch</option>
        <option value="youtube">youtube</option>
        <option value="kick">kick</option>
      </select>
      <input id="streamUrl" placeholder="stream_url" />
      <label>Is live: 
        <select id="streamIsLive">
          <option value="false">false</option>
          <option value="true">true</option>
        </select>
      </label>
      <input id="streamHostTeam" placeholder="host_team_id" />
      <input id="streamCompetitionId" placeholder="competition_id" />
      <button onclick="createStream()">POST /streams</button>
    </div>
  </div>

  <div class="section">
    <h3>Response</h3>
    <pre id="output" style="white-space:pre-wrap;max-height:400px;overflow:auto;background:#f8f8f8;padding:8px"></pre>
  </div>

  <script>
    // --- UTILITIES ---
    function clearFieldErrors(){ document.querySelectorAll('.field-error').forEach(n=>n.remove()); document.querySelectorAll('.input-error').forEach(i=>i.classList.remove('input-error')); }
    function showFieldError(field, msg){ try{ const el = document.getElementById(field) || document.querySelector('[name="'+field+'"]'); if(!el) return; el.classList.add('input-error'); const d=document.createElement('div'); d.className='field-error'; d.textContent = msg; if(el.nextSibling) el.parentNode.insertBefore(d, el.nextSibling); else el.parentNode.appendChild(d);}catch(e){console.warn('showFieldError',e)} }
    function showToast(message, type='info'){
      try{
        const container = document.getElementById('toastContainer'); if(!container) return;
        const t = document.createElement('div'); t.className = 'toast '+type; t.textContent = message;
        container.appendChild(t);
        // reveal
        setTimeout(()=>t.classList.add('visible'),10);
        // hide after timeout
        setTimeout(()=>{ t.classList.remove('visible'); setTimeout(()=>t.remove(),300); }, 6000);
      }catch(e){console.warn('showToast',e)}
    }

    function out(v){ clearFieldErrors(); document.getElementById('output').textContent = JSON.stringify(v,null,2); if (v && v.body){ const b = v.body; if (b.error) showToast(typeof b.error==='string'?b.error:JSON.stringify(b.error),'error'); if (b.message) showToast(b.message,'error'); } }
    function showStatus(status, body){ clearFieldErrors(); out({ status, body }); if (status>=200 && status<300) showToast('OK ('+status+')','success'); }
    function showError(status, err){ clearFieldErrors(); try{ const j = typeof err === 'string' ? { error: err } : (err || {}); out({ status, body: j }); if (j){ if (j.error) showToast(j.error,'error'); if (j.message) showToast(j.message,'error'); if (j.errors && typeof j.errors === 'object'){ Object.keys(j.errors).forEach(f=> showFieldError(f, Array.isArray(j.errors[f])?j.errors[f].join(', '):String(j.errors[f]))); } // common one-off shapes
        if (j.validation && Array.isArray(j.validation)){ j.validation.forEach(vi=> showToast(vi,'error')); }
      }
    }catch(e){ out({ status, error: String(err) }); showToast(String(err),'error'); } }
    function getBase(){ const b=document.getElementById('baseUrl').value.trim(); if(!b) throw {status:400, body:{error:'Base URL not set'}}; return b.replace(/\/$/,''); }
    function getHeaders(){ const t=document.getElementById('authToken').value.trim(); return t?{ 'Authorization': t, 'Content-Type':'application/json'}:{'Content-Type':'application/json'} }

    async function safeFetch(url, opts){
      const r = await fetch(url, opts);
      let body = null;
      try{ body = await r.json(); }catch(e){ body = await r.text().catch(()=>null); }
      if (!r.ok) throw { status: r.status, body };
      return { status: r.status, body };
    }

    async function apiGet(path){
      try{ const res = await safeFetch(getBase()+path, { headers:getHeaders() }); showStatus(res.status, res.body); }
      catch(e){ showError(e.status||500, e.body||e); }
    }

    // --- Auth helpers (login/register) and selects population ---
    async function login(){
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!email || !password) return out({ error: 'email and password are required' });
      try{
        const res = await safeFetch(getBase() + '/auth/login', { method:'POST', headers: getHeaders(), body: JSON.stringify({ email, password })});
        if (res.body && res.body.token) document.getElementById('authToken').value = 'Bearer ' + res.body.token;
        showStatus(res.status, res.body);
        await refreshLists();
      }catch(e){ showError(e.status||500, e.body||e); }
    }

    async function register(){
      const username = document.getElementById('regUsername').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const first_name = document.getElementById('regFirst').value.trim();
      const last_name = document.getElementById('regLast').value.trim();
      if (!username || !email || !password) return out({ error: 'username, email and password are required' });
      try{
        const res = await safeFetch(getBase() + '/auth/register', { method:'POST', headers:getHeaders(), body: JSON.stringify({ username, email, password, first_name, last_name })});
        if (res.body && res.body.token) document.getElementById('authToken').value = 'Bearer ' + res.body.token;
        showStatus(res.status, res.body);
        await refreshLists();
      }catch(e){ showError(e.status||500, e.body||e); }
    }

    async function fetchUsers(){
      try{
        const r = await safeFetch(getBase() + '/users', { headers: getHeaders() });
        const users = r.body;
        const selIds = ['tmUserId','noteUserId','teamCreatedBy','postAuthorId'];
        selIds.forEach(id => {
          const sel = document.getElementById(id);
          if (!sel) return;
          const placeholder = sel.querySelector('option');
          sel.innerHTML = '';
          sel.appendChild(placeholder || document.createElement('option'));
          sel.firstChild.value = '';
          sel.firstChild.textContent = '-- select user --';
          if (Array.isArray(users)) users.forEach(u => { const opt=document.createElement('option'); opt.value=u.id; opt.textContent=(u.username|| (u.first_name+' '+(u.last_name||''))).trim() + ' ('+u.id+')'; sel.appendChild(opt); });
        });
      }catch(e){ console.warn('fetchUsers failed', e); }
    }

    async function fetchCountries(){
      try{
        const r = await safeFetch(getBase() + '/countries', { headers: getHeaders() });
        const countries = r.body;
        const sel = document.getElementById('countrySelect');
        if (!sel) return;
        const placeholder = sel.querySelector('option'); sel.innerHTML = ''; sel.appendChild(placeholder||document.createElement('option'));
        sel.firstChild.value=''; sel.firstChild.textContent='-- select country --';
        if (Array.isArray(countries)) countries.forEach(c => { const opt=document.createElement('option'); opt.value=c.id; opt.textContent=(c.name||c.code)+' ('+c.id+')'; sel.appendChild(opt); });
      }catch(e){ console.warn('fetchCountries failed', e); }
    }

    async function refreshLists(){ await Promise.all([fetchUsers(), fetchCountries()]); out({ info: 'Lists refreshed' }); }

    // --- CREATE HELPERS ---
    async function createPost(){
      const title = postTitle.value.trim();
      const content = postContent.value.trim();
      if (!title || !content) return out({ error: 'title and content are required' });
      const payload = { title, content };
      if (postAuthorId.value.trim()) payload.author_id = postAuthorId.value.trim();
      if (postMedia.value.trim()) payload.media_urls = postMedia.value.split(',').map(s=>s.trim());
      try{ const res = await safeFetch(getBase()+'/posts',{method:'POST',headers:getHeaders(),body:JSON.stringify(payload)}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function createCompetition(){
      const title = compTitle.value.trim();
      const slug = compSlug.value.trim();
      if (!title || !slug) return out({ error: 'title and slug are required' });
      const payload = {
        title, slug,
        description: compDescription.value.trim() || undefined,
        country_id: compCountryId.value || undefined,
        registration_start: compRegistrationStart.value || undefined,
        registration_end: compRegistrationEnd.value || undefined,
        start_date: compStartDate.value || undefined,
        end_date: compEndDate.value || undefined,
        rules_url: compRulesUrl.value || undefined,
        stream_url: (()=>{const v=compStreamUrl.value.trim();try{return v?JSON.parse(v):undefined}catch(e){return v||undefined}})()
      };
      try{ const res = await safeFetch(getBase()+'/competitions',{method:'POST',headers:getHeaders(),body:JSON.stringify(payload)}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function createTeam(){
      const name = teamName.value.trim();
      if (!name) return out({ error: 'team name is required' });
      const payload = {
        name,
        country_id: teamCountryId.value || undefined,
        city: teamCity.value || undefined,
        institution: teamInstitution.value || undefined,
        logo_url: teamLogo.value || undefined,
        social_links: (()=>{ const v=teamSocialLinks.value.trim(); if(!v)return undefined; try{return JSON.parse(v)}catch(e){return undefined}})(),
        created_by_user_id: teamCreatedBy.value || undefined
      };
      try{ const res = await safeFetch(getBase()+'/teams',{method:'POST',headers:getHeaders(),body:JSON.stringify(payload)}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function createRegistration(){
      const team_id = regTeamId.value.trim();
      const competition_id = regCompetitionId.value.trim();
      if (!team_id || !competition_id) return out({ error: 'team_id and competition_id are required' });
      const payload = { team_id, competition_id, status: regStatus.value, registration_date: regDate.value || undefined };
      try{ const res = await safeFetch(getBase()+'/registrations',{method:'POST',headers:getHeaders(),body:JSON.stringify(payload)}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function createTeamMember(){
      const team_id = tmTeamId.value.trim();
      const user_id = tmUserId.value.trim();
      const role = tmRole.value.trim();
      if (!team_id || !user_id || !role) return out({ error: 'team_id, user_id and role are required' });
      const payload = { team_id, user_id, role, joined_at: tmJoinedAt.value || undefined, left_at: tmLeftAt.value || undefined };
      try{ const res = await safeFetch(getBase()+'/team-members',{method:'POST',headers:getHeaders(),body:JSON.stringify(payload)}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function createNotification(){
      const user_id = noteUserId.value.trim();
      const title = noteTitle.value.trim();
      const type = noteType.value;
      const message = noteMessage.value.trim();
      if (!user_id || !title || !type || !message) return out({ error: 'user_id, title, type and message are required' });
      try{ const res = await safeFetch(getBase()+'/notifications',{method:'POST',headers:getHeaders(),body:JSON.stringify({user_id,title,type,message})}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function markNotificationRead(){
      const id = noteId.value.trim(); if(!id) return out({error:'provide id'});
      try{ const res = await safeFetch(getBase()+'/notifications/'+encodeURIComponent(id),{method:'PUT',headers:getHeaders(),body:JSON.stringify({is_read:true})}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function deleteNotification(){
      const id = noteId.value.trim(); if(!id) return out({error:'provide id'});
      try{ const res = await safeFetch(getBase()+'/notifications/'+encodeURIComponent(id),{method:'DELETE',headers:getHeaders()}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function createCountry(){
      const name = countryName.value.trim();
      const code = countryCode.value.trim();
      if (!name || !code) return out({ error: 'country name and code are required' });
      const flag = countryFlag.value.trim() || undefined;
      try{ const res = await safeFetch(getBase()+'/countries',{method:'POST',headers:getHeaders(),body:JSON.stringify({name,code,flag_emoji:flag})}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function createSponsor(){
      const name = sponsorName.value.trim();
      if (!name) return out({ error: 'sponsor name is required' });
      const logo = sponsorLogo.value.trim() || undefined;
      const website = sponsorWebsite.value.trim() || undefined;
      try{ const res = await safeFetch(getBase()+'/sponsors',{method:'POST',headers:getHeaders(),body:JSON.stringify({name,logo_url:logo,website_url:website})}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function createStream(){
      const title = streamTitle.value.trim();
      if (!title) return out({ error: 'stream title is required' });
      const payload = {
        title,
        description: streamDescription.value || undefined,
        platform: streamPlatform.value || undefined,
        stream_url: streamUrl.value || undefined,
        is_live: streamIsLive.value === 'true',
        host_team_id: streamHostTeam.value || undefined,
        competition_id: streamCompetitionId.value || undefined
      };
      try{ const res = await safeFetch(getBase()+'/streams',{method:'POST',headers:getHeaders(),body:JSON.stringify(payload)}); showStatus(res.status,res.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }

    async function getById(){
      const id = resourceId.value.trim();
      const res = resourceSelect.value;
      if (!id) return out({ error: 'resource id is required' });
      try{ const result = await safeFetch(getBase()+'/'+res+'/'+encodeURIComponent(id),{headers:getHeaders()}); showStatus(result.status,result.body); }
      catch(e){ showError(e.status||500,e.body||e); }
    }
  </script>

  <script>
    // UI helper text injection and small UX helpers
    const HELPERS = {
      postTitle: 'Short, descriptive title. Example: "Best Robot 2025"',
      postContent: 'Main content of the post. Markdown is supported in some endpoints.',
      postAuthorId: 'Optional: UUID of an existing user. Use the selector after login to pick a user.',
      compTitle: 'Competition full name (required).',
      compSlug: 'URL-friendly identifier (no spaces).',
      compCountryId: 'Optional: choose a host country id from the countries selector.',
      teamName: 'Team official name. Required.',
      teamCountryId: 'Optional: choose a country id from the countries selector.',
      teamCreatedBy: 'Optional: choose the user who created this team. If left blank, the authenticated user will be used when supported.',
      noteTitle: 'Short title shown in user notifications. Required.',
      noteType: 'Notification category. Pick the best match for the event.',
      noteMessage: 'Full message body of the notification. Keep it concise.',
      countryName: 'Country display name, e.g. "Spain"',
      countryCode: 'ISO country code, e.g. "ES"',
      sponsorName: 'Sponsor or partner name (required).',
      streamTitle: 'Short title for the stream (required).'
    };

    function insertHelpTexts(){
      Object.keys(HELPERS).forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        // avoid duplicating
        const next = el.nextElementSibling;
        if (next && next.classList && next.classList.contains('help-text')) return;
        const d = document.createElement('div'); d.className='help-text'; d.textContent = HELPERS[id];
        if (el.parentNode) el.parentNode.insertBefore(d, el.nextSibling);
        // clear field error when user types
        el.addEventListener('input', ()=>{ if (el.classList.contains('input-error')){ el.classList.remove('input-error'); const fe = el.parentNode.querySelector('.field-error'); if (fe) fe.remove(); } });
      });
      // Add little help icons to section headings for quick tips
      document.querySelectorAll('.section h3, .section h4').forEach(h=>{
        if (h.querySelector('.help-icon')) return;
        const ic = document.createElement('span'); ic.className='help-icon'; ic.textContent='?'; ic.title = 'Use the fields below to create and test API resources. Hover inputs for inline help.';
        h.appendChild(ic);
      });
    }

    // Run on load
    window.addEventListener('load', ()=>{
      insertHelpTexts();
    });
  </script>
</body>
</html>
