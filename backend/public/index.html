<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RobEurope — Test UI</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:980px; margin:20px auto; padding:0 16px; }
    section { border:1px solid #ddd; padding:16px; margin-bottom:16px; border-radius:6px; }
    label { display:block; margin-top:8px; }
    input, select, textarea { width:100%; padding:8px; box-sizing:border-box; margin-top:4px; }
    button { margin-top:12px; padding:8px 12px; cursor:pointer; }
    .row { display:flex; gap:12px; }
    .col { flex:1; }
    pre { background:#f7f7f7; padding:8px; overflow:auto; }
    .msg { margin-top:8px; color:green; }
    .err { margin-top:8px; color:red; }
    .tokenBox { background:#111; color:#0f0; padding:8px; border-radius:4px; font-family:monospace; white-space:pre-wrap; word-break:break-all; }
    .big { font-weight:700; font-size:0.95rem; }
    .small { font-size:0.85rem; color:#666; }
  </style>
</head>
<body>
  <h1>RobEurope — Test UI</h1>

  <section id="auth">
    <h2>Register</h2>
    <form id="registerForm">
      <div class="row">
        <div class="col">
          <label>First name<input name="first_name" required></label>
        </div>
        <div class="col">
          <label>Last name<input name="last_name" required></label>
        </div>
      </div>
      <label>Email<input name="email" type="email" required></label>
      <label>Password<input name="password" type="password" required></label>
      <label>Phone<input name="phone" required></label>
      <label>Country<select id="countrySelect" name="country_id" required></select></label>
      <button type="submit">Register</button>
      <div id="registerMsg"></div>
    </form>

    <h2 style="margin-top:18px">Login</h2>
    <form id="loginForm">
      <label>Email<input name="email" type="email" required></label>
      <label>Password<input name="password" type="password" required></label>
      <button type="submit">Login</button>
      <div id="loginMsg"></div>
    </form>

    <div id="authInfo" style="margin-top:18px; display:none;">
      <h3>Authentication info (JWT)</h3>
      <div class="small">Authorization header:</div>
      <div id="authHeader" class="tokenBox small"></div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="copyTokenBtn">Copy token</button>
        <button id="revokeTokenBtn">Clear token</button>
      </div>
      <h4 style="margin-top:12px">Token (compact JWT)</h4>
      <textarea id="tokenField" rows="3" readonly class="tokenBox"></textarea>
      <h4 style="margin-top:12px">Decoded payload</h4>
      <pre id="tokenPayload" class="tokenBox"></pre>
      <div id="authUser" class="big" style="margin-top:8px"></div>
    </div>
  </section>

  <section id="profileSection" style="display:none">
    <h2>My profile</h2>
    <button id="loadProfileBtn">Load my profile</button>
    <div id="profileMsg"></div>

    <form id="profileForm" style="display:none; margin-top:12px">
      <label>First name<input name="first_name" required></label>
      <label>Last name<input name="last_name" required></label>
      <label>Phone<input name="phone" required></label>
      <label>Profile photo URL<input name="profile_photo_url"></label>
      <label>Country<select id="profileCountrySelect" name="country_id" required></select></label>

      <div class="row">
        <button type="submit">Save changes</button>
        <button type="button" id="deleteAccountBtn" style="background:#c33;color:#fff">Delete account</button>
        <button type="button" id="logoutBtn">Logout</button>
      </div>

      <div id="profileResult"></div>
    </form>
  </section>

  <section>
    <h2>Quick API tester</h2>
    <p>Search users (q param):</p>
    <form id="searchForm">
      <input name="q" placeholder="email or name" required>
      <button>Search</button>
    </form>
    <pre id="searchResult"></pre>
  </section>

  <script>
    const baseUrl = window.location.origin;
    const countrySelect = document.getElementById('countrySelect');
    const profileCountrySelect = document.getElementById('profileCountrySelect');

    function getToken() { return localStorage.getItem('token'); }
    function setToken(t) { if (t) localStorage.setItem('token', t); else localStorage.removeItem('token'); updateAuthUI(); showToken(t); }

    function parseJwt(token) {
      try {
        const parts = token.split('.');
        if (parts.length !== 3) return null;
        const payload = parts[1].replace(/-/g,'+').replace(/_/g,'/');
        const json = decodeURIComponent(atob(payload).split('').map(c=> '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        return JSON.parse(json);
      } catch(e) { return null; }
    }

    function showToken(token) {
      const info = document.getElementById('authInfo');
      const field = document.getElementById('tokenField');
      const header = document.getElementById('authHeader');
      const payloadPre = document.getElementById('tokenPayload');
      const authUser = document.getElementById('authUser');

      if (!token) {
        info.style.display = 'none';
        field.value = '';
        header.textContent = '';
        payloadPre.textContent = '';
        authUser.textContent = '';
        return;
      }
      info.style.display = 'block';
      field.value = token;
      header.textContent = 'Authorization: Bearer ' + token;
      const payload = parseJwt(token);
      payloadPre.textContent = payload ? JSON.stringify(payload, null, 2) : 'Unable to decode payload';
      authUser.textContent = payload ? `Authenticated as: ${payload.email || payload.id || 'unknown'} — role: ${payload.role || 'n/a'}` : '';
    }

    document.getElementById('copyTokenBtn').addEventListener('click', async () => {
      const token = getToken();
      if (!token) return alert('No token');
      try {
        await navigator.clipboard.writeText(token);
        alert('Token copied to clipboard');
      } catch (e) {
        prompt('Copy token manually:', token);
      }
    });
    document.getElementById('revokeTokenBtn').addEventListener('click', () => { setToken(null); alert('Token cleared'); });

    async function loadCountries() {
      try {
        const res = await fetch(baseUrl + '/api/countries');
        if (!res.ok) throw new Error('Failed to load countries: ' + res.status);
        const countries = await res.json();
        countrySelect.innerHTML = '<option value="">Select country</option>';
        profileCountrySelect.innerHTML = '<option value="">Select country</option>';
        countries.forEach(c => {
          const txt = `${c.flag_emoji ? c.flag_emoji + ' ' : ''}${c.name} (${c.code})`;
          const opt = `<option value="${c.id}">${txt}</option>`;
          countrySelect.insertAdjacentHTML('beforeend', opt);
          profileCountrySelect.insertAdjacentHTML('beforeend', opt);
        });
      } catch (err) {
        console.error(err);
        countrySelect.innerHTML = '<option value="">Error loading countries</option>';
        profileCountrySelect.innerHTML = '<option value="">Error</option>';
      }
    }

    // Register: send email/password base64 encoded (server decodes with atob)
    document.getElementById('registerForm').addEventListener('submit', async e => {
      e.preventDefault();
      const f = e.target;
      const rawEmail = f.email.value.trim();
      const rawPassword = f.password.value;
      const body = {
        first_name: f.first_name.value.trim(),
        last_name: f.last_name.value.trim(),
        email: btoa(rawEmail),
        password: btoa(rawPassword),
        phone: f.phone.value.trim(),
        country_id: Number(f.country_id.value)
      };
      const msg = document.getElementById('registerMsg'); msg.textContent=''; msg.className='';
      try {
        const res = await fetch(baseUrl + '/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) { msg.className='err'; msg.textContent = data.error || JSON.stringify(data); return; }
        // store token
        if (data.token) setToken(data.token);
        msg.className='msg'; msg.textContent = 'Registered. Token saved and visible below.';
        document.getElementById('profileSection').style.display = 'block';
      } catch (err) {
        msg.className='err'; msg.textContent = err.message;
      }
    });

    // Login: send base64 email/password
    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const f = e.target;
      const rawEmail = f.email.value.trim();
      const rawPassword = f.password.value;
      const body = { email: btoa(rawEmail), password: btoa(rawPassword) };
      const msg = document.getElementById('loginMsg'); msg.textContent=''; msg.className='';
      try {
        const res = await fetch(baseUrl + '/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) { msg.className='err'; msg.textContent = data.error || JSON.stringify(data); return; }
        setToken(data.token);
        msg.className='msg'; msg.textContent = 'Logged in. Token saved and visible below.';
        document.getElementById('profileSection').style.display = 'block';
      } catch (err) {
        msg.className='err'; msg.textContent = err.message;
      }
    });

    // Load my profile
    document.getElementById('loadProfileBtn').addEventListener('click', loadMyProfile);

    async function authFetch(url, opts = {}) {
      const token = getToken();
      opts.headers = opts.headers || {};
      if (token) opts.headers['Authorization'] = 'Bearer ' + token;
      return fetch(url, opts);
    }

    async function loadMyProfile() {
      const token = getToken();
      const msg = document.getElementById('profileMsg'); msg.textContent=''; msg.className='';
      if (!token) { msg.className='err'; msg.textContent='No token. Login first.'; return; }
      try {
        const res = await authFetch(baseUrl + '/api/users/me');
        const data = await res.json();
        if (!res.ok) { msg.className='err'; msg.textContent = data.error || JSON.stringify(data); return; }
        msg.className='msg'; msg.textContent='Profile loaded';
        const form = document.getElementById('profileForm');
        form.style.display = 'block';
        form.first_name.value = data.first_name || '';
        form.last_name.value = data.last_name || '';
        form.phone.value = data.phone || '';
        form.profile_photo_url.value = data.profile_photo_url || '';
        profileCountrySelect.value = data.country_id || '';
        document.getElementById('profileResult').textContent = '';
      } catch (err) {
        msg.className='err'; msg.textContent = err.message;
      }
    }

    // Update profile
    document.getElementById('profileForm').addEventListener('submit', async e => {
      e.preventDefault();
      const token = getToken();
      const msg = document.getElementById('profileResult'); msg.textContent=''; msg.className='';
      if (!token) { msg.className='err'; msg.textContent='No token.'; return; }
      const f = e.target;
      const body = {
        first_name: f.first_name.value.trim(),
        last_name: f.last_name.value.trim(),
        phone: f.phone.value.trim(),
        profile_photo_url: f.profile_photo_url.value.trim(),
        country_id: Number(f.country_id.value)
      };
      try {
        const res = await authFetch(baseUrl + '/api/users/me', {
          method: 'PATCH',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) { msg.className='err'; msg.textContent = data.error || JSON.stringify(data); return; }
        msg.className='msg'; msg.textContent = 'Profile updated';
      } catch (err) {
        msg.className='err'; msg.textContent = err.message;
      }
    });

    // Delete account
    document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
      if (!confirm('¿Borrar cuenta? Esta acción no se puede deshacer.')) return;
      const token = getToken();
      if (!token) return alert('No token.');
      try {
        const res = await authFetch(baseUrl + '/api/users/me', { method: 'DELETE' });
        const data = await res.json();
        if (!res.ok) return alert('Error: ' + (data.error || JSON.stringify(data)));
        setToken(null);
        alert('Cuenta eliminada');
        document.getElementById('profileForm').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
      } catch (err) {
        alert(err.message);
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => { setToken(null); alert('Logged out'); });

    // Search users
    document.getElementById('searchForm').addEventListener('submit', async e => {
      e.preventDefault();
      const q = e.target.q.value.trim();
      const out = document.getElementById('searchResult'); out.textContent = 'Loading...';
      try {
        const res = await fetch(baseUrl + '/api/users?q=' + encodeURIComponent(q));
        const data = await res.json();
        out.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        out.textContent = err.message;
      }
    });

    function updateAuthUI() {
      const token = getToken();
      document.getElementById('profileSection').style.display = token ? 'block' : 'none';
      showToken(token);
    }

    // Init
    (async function init() {
      await loadCountries();
      updateAuthUI();
    })();
  </script>
</body>
</html>