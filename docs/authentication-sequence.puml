@startuml Authentication Sequence Diagram

title Authentication Flow Sequence Diagram

actor "User" as User
participant "Frontend" as Frontend
participant "API Gateway\n(Nginx)" as Gateway
participant "Auth Controller" as Controller
participant "Auth Service" as AuthService
participant "User Model" as UserModel
participant "Database" as DB
participant "JWT Service" as JWT
participant "Session Store" as Session

== Login Process ==
User -> Frontend: Enter credentials
Frontend -> Gateway: POST /api/auth/login
Gateway -> Controller: login(request)

Controller -> AuthService: validateCredentials(username, password)
AuthService -> UserModel: findByUsername(username)
UserModel -> DB: SELECT * FROM users WHERE username = ?
DB --> UserModel: user data
UserModel --> AuthService: user object

AuthService -> AuthService: validatePassword(password, user.hash)
AuthService --> Controller: user (valid) or error

alt Successful Authentication
    Controller -> JWT: generateToken(user)
    JWT --> Controller: jwt_token

    Controller -> Session: createSession(user)
    Session --> Controller: session_id

    Controller --> Gateway: {token, user, session}
    Gateway --> Frontend: Login successful

    Frontend -> Frontend: Store JWT token
    Frontend -> Frontend: Redirect to dashboard

else Invalid Credentials
    Controller --> Gateway: 401 Unauthorized
    Gateway --> Frontend: Login failed
    Frontend -> User: Show error message
end

== Protected Route Access ==
User -> Frontend: Access protected page
Frontend -> Gateway: GET /api/protected-resource\nAuthorization: Bearer <token>
Gateway -> Controller: protectedResource(request)

Controller -> JWT: verifyToken(token)
JWT --> Controller: decoded_payload or error

alt Valid Token
    Controller -> UserModel: findById(decoded.userId)
    UserModel -> DB: SELECT * FROM users WHERE id = ?
    DB --> UserModel: user data
    UserModel --> Controller: user

    Controller -> Controller: checkPermissions(user, resource)
    Controller --> Gateway: resource data
    Gateway --> Frontend: Protected content

else Invalid/Expired Token
    Controller --> Gateway: 401 Unauthorized
    Gateway --> Frontend: Redirect to login
end

== Logout Process ==
User -> Frontend: Click logout
Frontend -> Gateway: POST /api/auth/logout
Gateway -> Controller: logout(request)

Controller -> JWT: invalidateToken(request.token)
Controller -> Session: destroySession(request.sessionId)

Controller --> Gateway: Logout successful
Gateway --> Frontend: Logout confirmation

Frontend -> Frontend: Clear local storage
Frontend -> Frontend: Redirect to login

== Session Validation (Admin Panel) ==
User -> Frontend: Access admin panel
Frontend -> Gateway: GET /admin/dashboard
Gateway -> Controller: adminDashboard(request)

Controller -> Session: validateSession(sessionId)
Session --> Controller: session_data or null

alt Valid Session
    Controller -> Controller: checkAdminRole(session.user)
    Controller --> Gateway: Admin dashboard
    Gateway --> Frontend: Admin interface

else Invalid Session
    Controller --> Gateway: 401 Unauthorized
    Gateway --> Frontend: Redirect to admin login
end

@enduml