<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: backend/controller/ldap.controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: backend/controller/ldap.controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Admin-only LDAP management controllers (server-rendered).
 *
 * These handlers are mounted under the admin panel routes (see `backend/routes/admin.route.js`).
 * They bind with the configured service account and allow listing/adding/editing/deleting users
 * in the LDAP directory.
 */

import ldap from 'ldapjs';
import attributePkg from '@ldapjs/attribute';
const Attribute = attributePkg; // CJS default export is the class itself
import dotenv from 'dotenv';
dotenv.config();

const client = ldap.createClient({
  url: process.env.LDAP_URL,
});


client.on('error', (err) => {
  console.error('LDAP Client Error:', err.message);
});

// Align with .env used by passport-ldapauth and init-ldap
const baseDN = process.env.LDAP_SEARCH_BASE; // e.g., dc=robeurope,dc=samuelponce,dc=es
const userDN = `ou=users,${baseDN}`;

const bindClient = () => {
  return new Promise((resolve, reject) => {
    client.bind(process.env.LDAP_BIND_DN, process.env.LDAP_BIND_PASSWORD, (err) => {
      if (err) reject(err);
      else resolve();
    });
  });
};


/**
 * Render the LDAP user list page.
 *
 * @route GET /admin/ldap-users
 * @param {Express.Request} req
 * @param {Express.Response} res
 * @returns {Promise&lt;void>}
 */
export const listLdapUsers = async (req, res) => {
  try {
    await bindClient();
    const opts = {
      filter: '(objectClass=person)',
      scope: 'sub',
      attributes: ['cn', 'sn', 'mail', 'uid']
    };
  console.log(`Searching LDAP users in ${userDN} with filter ${opts.filter}`);
    client.search(userDN, opts, (err, search) => {
      if (err) {
        console.error('LDAP Search Error:', err);
        return res.status(500).json({ error: err.message });
      }
      const users = [];
      search.on('searchEntry', (entry) => {
        let userObj = entry.object;
        
        if (!userObj) {
           
            userObj = {};
            const attributes = entry.attributes || (entry.pojo &amp;&amp; entry.pojo.attributes) || [];
            attributes.forEach(attr => {
                // attr.type is the key (e.g. 'uid'), attr.values is the value array
                if (attr.type &amp;&amp; attr.values) {
                    userObj[attr.type] = attr.values;
                }
            });
           
            if (entry.objectName) userObj.dn = entry.objectName;
        }
        
        console.log('Processed User Object:', userObj);
        users.push(userObj);
      });
      search.on('end', (result) => {
        console.log('LDAP Search finished. Users found:', users.length);
        res.render('admin/ldap-users', { users, title: req.__('ldap.metaTitle'), pageKey: 'ldap' });
      });
      search.on('error', (err) => {
        console.error('LDAP Search Stream Error:', err);
        res.status(500).json({ error: err.message });
      });
    });
  } catch (error) {
    console.error('LDAP Controller Error:', error);
    res.status(500).json({ error: error.message });
  }
};


/**
 * Render the LDAP user creation form.
 *
 * @route GET /admin/ldap-users/add
 * @param {Express.Request} req
 * @param {Express.Response} res
 */
export const renderAddLdapUser = (req, res) => {
  res.render('admin/ldap-user-form', { user: null, action: 'add', title: req.__('ldap.form.addTitle'), pageKey: 'ldap' });
};


/**
 * Create a new LDAP user.
 *
 * @route POST /admin/ldap-users/add
 * @param {Express.Request} req
 * @param {Express.Response} res
 * @returns {Promise&lt;void>}
 */
export const addLdapUser = async (req, res) => {
  const { uid, cn, sn, mail, password } = req.body;
  const dn = `uid=${uid},${userDN}`;
  const entry = {
    uid,
    cn,
    sn,
    mail,
    objectClass: ['person', 'organizationalPerson', 'inetOrgPerson'],
    userPassword: password // In production, hash this
  };
  console.log(`Adding LDAP user: ${dn}`, entry);
  try {
    await bindClient();
    client.add(dn, entry, (err) => {
      if (err) {
        console.error('LDAP Add Error:', err);
        return res.status(500).json({ error: err.message });
      }
      console.log('LDAP User added successfully');
      // DELAY TO ENSURE THE USER IS WEELL PROCESSED BEFORE REDIRECT
      setTimeout(() => {
        res.redirect('/admin/ldap-users');
      }, 500);
    });
  } catch (error) {
    console.error('LDAP Add Controller Error:', error);
    res.status(500).json({ error: error.message });
  }
};

/**
 * Render the LDAP user edit form for the given uid.
 *
 * @route GET /admin/ldap-users/edit/:uid
 * @param {Express.Request} req
 * @param {Express.Response} res
 * @returns {Promise&lt;void>}
 */
export const renderEditLdapUser = async (req, res) => {
  const uid = req.params.uid;
  const dn = `uid=${uid},${userDN}`;
  try {
    await bindClient();
    client.search(dn, { scope: 'base' }, (err, search) => {
      if (err) return res.status(500).json({ error: err.message });
      search.on('searchEntry', (entry) => {
        // Pass the uid used to reach this page to avoid missing param issues in the form action
        res.render('admin/ldap-user-form', { user: entry.object, action: 'edit', formUid: uid, title: req.__('ldap.form.editTitle'), pageKey: 'ldap' });
      });
      search.on('error', (err) => {
        res.status(500).json({ error: err.message });
      });
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};


/**
 * Update an LDAP user.
 *
 * Note: admin routes allow both `POST /admin/ldap-users/edit/:uid` and a fallback
 * `POST /admin/ldap-users/edit` where `uid` is taken from the body.
 *
 * @route POST /admin/ldap-users/edit/:uid
 * @route POST /admin/ldap-users/edit
 * @param {Express.Request} req
 * @param {Express.Response} res
 * @returns {Promise&lt;void>}
 */
export const updateLdapUser = async (req, res) => {
  const uid = req.params.uid || req.body.uid;
  const { cn, sn, mail, password } = req.body;
  const dn = `uid=${uid},${userDN}`;
  const toAttr = (type, value) => new Attribute({ type, values: Array.isArray(value) ? value : [value] });
  const changes = [];
  if (cn) changes.push(new ldap.Change({ operation: 'replace', modification: toAttr('cn', cn) }));
  if (sn) changes.push(new ldap.Change({ operation: 'replace', modification: toAttr('sn', sn) }));
  if (mail) changes.push(new ldap.Change({ operation: 'replace', modification: toAttr('mail', mail) }));
  if (password) changes.push(new ldap.Change({ operation: 'replace', modification: toAttr('userPassword', password) }));
  if (changes.length === 0) {
    return res.redirect('/admin/ldap-users');
  }
  try {
    await bindClient();
    client.modify(dn, changes, (err) => {
      if (err) return res.status(500).json({ error: err.message });
      res.redirect('/admin/ldap-users');
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};


/**
 * Delete an LDAP user.
 *
 * @route POST /admin/ldap-users/delete/:uid
 * @param {Express.Request} req
 * @param {Express.Response} res
 * @returns {Promise&lt;void>}
 */
export const deleteLdapUser = async (req, res) => {
  const uid = req.params.uid;
  const dn = `uid=${uid},${userDN}`;
  try {
    await bindClient();
    client.del(dn, (err) => {
      if (err) return res.status(500).json({ error: err.message });
      res.redirect('/admin/ldap-users');
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="SystemLogger.html">SystemLogger</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AuthProvider">AuthProvider</a></li><li><a href="global.html#NotificationsBell">NotificationsBell</a></li><li><a href="global.html#SocketProvider">SocketProvider</a></li><li><a href="global.html#acceptInvite">acceptInvite</a></li><li><a href="global.html#addComment">addComment</a></li><li><a href="global.html#addFavoriteCompetition">addFavoriteCompetition</a></li><li><a href="global.html#addLdapUser">addLdapUser</a></li><li><a href="global.html#apiRequest">apiRequest</a></li><li><a href="global.html#approveJoinRequest">approveJoinRequest</a></li><li><a href="global.html#approveRegistration">approveRegistration</a></li><li><a href="global.html#canUseNotifications">canUseNotifications</a></li><li><a href="global.html#changePassword">changePassword</a></li><li><a href="global.html#cn">cn</a></li><li><a href="global.html#createCountry">createCountry</a></li><li><a href="global.html#createGalleryItem">createGalleryItem</a></li><li><a href="global.html#createLogEntry">createLogEntry</a></li><li><a href="global.html#createNotification">createNotification</a></li><li><a href="global.html#createPost">createPost</a></li><li><a href="global.html#createRegistration">createRegistration</a></li><li><a href="global.html#createSponsor">createSponsor</a></li><li><a href="global.html#createStream">createStream</a></li><li><a href="global.html#createTeam">createTeam</a></li><li><a href="global.html#createTeamMember">createTeamMember</a></li><li><a href="global.html#createUser">createUser</a></li><li><a href="global.html#declineInvite">declineInvite</a></li><li><a href="global.html#decodeIfBase64">decodeIfBase64</a></li><li><a href="global.html#deleteCompetition">deleteCompetition</a></li><li><a href="global.html#deleteCountry">deleteCountry</a></li><li><a href="global.html#deleteGalleryItem">deleteGalleryItem</a></li><li><a href="global.html#deleteKey">deleteKey</a></li><li><a href="global.html#deleteLdapUser">deleteLdapUser</a></li><li><a href="global.html#deleteLogEntry">deleteLogEntry</a></li><li><a href="global.html#deleteMedia">deleteMedia</a></li><li><a href="global.html#deleteNotification">deleteNotification</a></li><li><a href="global.html#deleteOldLogs">deleteOldLogs</a></li><li><a href="global.html#deletePost">deletePost</a></li><li><a href="global.html#deleteRegistration">deleteRegistration</a></li><li><a href="global.html#deleteRobotFile">deleteRobotFile</a></li><li><a href="global.html#deleteSelf">deleteSelf</a></li><li><a href="global.html#deleteSponsor">deleteSponsor</a></li><li><a href="global.html#deleteStream">deleteStream</a></li><li><a href="global.html#deleteTeam">deleteTeam</a></li><li><a href="global.html#deleteTeamMember">deleteTeamMember</a></li><li><a href="global.html#deleteUser">deleteUser</a></li><li><a href="global.html#down">down</a></li><li><a href="global.html#emitToUser">emitToUser</a></li><li><a href="global.html#exportRegistrationsCSV">exportRegistrationsCSV</a></li><li><a href="global.html#forgotPassword">forgotPassword</a></li><li><a href="global.html#form">form</a></li><li><a href="global.html#getApiOrigin">getApiOrigin</a></li><li><a href="global.html#getComments">getComments</a></li><li><a href="global.html#getCompetitionById">getCompetitionById</a></li><li><a href="global.html#getCompetitions">getCompetitions</a></li><li><a href="global.html#getCountries">getCountries</a></li><li><a href="global.html#getCountryById">getCountryById</a></li><li><a href="global.html#getFileInfo">getFileInfo</a></li><li><a href="global.html#getIO">getIO</a></li><li><a href="global.html#getKeyInfo">getKeyInfo</a></li><li><a href="global.html#getMediaById">getMediaById</a></li><li><a href="global.html#getMembershipStatus">getMembershipStatus</a></li><li><a href="global.html#getMessages">getMessages</a></li><li><a href="global.html#getMyTeam">getMyTeam</a></li><li><a href="global.html#getNotificationById">getNotificationById</a></li><li><a href="global.html#getNotifications">getNotifications</a></li><li><a href="global.html#getOverview">getOverview</a></li><li><a href="global.html#getPostById">getPostById</a></li><li><a href="global.html#getPosts">getPosts</a></li><li><a href="global.html#getRegistrationById">getRegistrationById</a></li><li><a href="global.html#getRegistrationStats">getRegistrationStats</a></li><li><a href="global.html#getRegistrations">getRegistrations</a></li><li><a href="global.html#getResendClient">getResendClient</a></li><li><a href="global.html#getRobotFiles">getRobotFiles</a></li><li><a href="global.html#getSelf">getSelf</a></li><li><a href="global.html#getSponsorById">getSponsorById</a></li><li><a href="global.html#getSponsors">getSponsors</a></li><li><a href="global.html#getStreamById">getStreamById</a></li><li><a href="global.html#getStreams">getStreams</a></li><li><a href="global.html#getSystemLogById">getSystemLogById</a></li><li><a href="global.html#getSystemLogs">getSystemLogs</a></li><li><a href="global.html#getSystemStats">getSystemStats</a></li><li><a href="global.html#getTeamById">getTeamById</a></li><li><a href="global.html#getTeamLogs">getTeamLogs</a></li><li><a href="global.html#getTeamMemberById">getTeamMemberById</a></li><li><a href="global.html#getTeamMembers">getTeamMembers</a></li><li><a href="global.html#getTeams">getTeams</a></li><li><a href="global.html#getUserById">getUserById</a></li><li><a href="global.html#getUsers">getUsers</a></li><li><a href="global.html#getUsersByRole">getUsersByRole</a></li><li><a href="global.html#getUsersTimeline">getUsersTimeline</a></li><li><a href="global.html#getVapidPublicKey">getVapidPublicKey</a></li><li><a href="global.html#handleUploadErrors">handleUploadErrors</a></li><li><a href="global.html#inviteToTeam">inviteToTeam</a></li><li><a href="global.html#leaveTeam">leaveTeam</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#listFavoriteCompetitions">listFavoriteCompetitions</a></li><li><a href="global.html#listGallery">listGallery</a></li><li><a href="global.html#listJoinRequests">listJoinRequests</a></li><li><a href="global.html#listKeys">listKeys</a></li><li><a href="global.html#listLdapUsers">listLdapUsers</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#me">me</a></li><li><a href="global.html#normalizeBase">normalizeBase</a></li><li><a href="global.html#parseResponse">parseResponse</a></li><li><a href="global.html#redirectIfAuthenticated">redirectIfAuthenticated</a></li><li><a href="global.html#reducer">reducer</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#registerTeamInCompetition">registerTeamInCompetition</a></li><li><a href="global.html#rejectRegistration">rejectRegistration</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeFavoriteCompetition">removeFavoriteCompetition</a></li><li><a href="global.html#renderAddLdapUser">renderAddLdapUser</a></li><li><a href="global.html#renderEditLdapUser">renderEditLdapUser</a></li><li><a href="global.html#requestJoinTeam">requestJoinTeam</a></li><li><a href="global.html#requestNotificationPermission">requestNotificationPermission</a></li><li><a href="global.html#requireAdminSession">requireAdminSession</a></li><li><a href="global.html#requireOwnership">requireOwnership</a></li><li><a href="global.html#requireRole">requireRole</a></li><li><a href="global.html#resetPassword">resetPassword</a></li><li><a href="global.html#resolveMediaUrl">resolveMediaUrl</a></li><li><a href="global.html#save">save</a></li><li><a href="global.html#searchUsers">searchUsers</a></li><li><a href="global.html#sendMessage">sendMessage</a></li><li><a href="global.html#sendPasswordResetCodeEmail">sendPasswordResetCodeEmail</a></li><li><a href="global.html#sendTestPush">sendTestPush</a></li><li><a href="global.html#setIO">setIO</a></li><li><a href="global.html#showNotification">showNotification</a></li><li><a href="global.html#subscribePush">subscribePush</a></li><li><a href="global.html#subscribeToPush">subscribeToPush</a></li><li><a href="global.html#toggleFileVisibility">toggleFileVisibility</a></li><li><a href="global.html#toggleLike">toggleLike</a></li><li><a href="global.html#togglePin">togglePin</a></li><li><a href="global.html#unsubscribeFromPush">unsubscribeFromPush</a></li><li><a href="global.html#unsubscribePush">unsubscribePush</a></li><li><a href="global.html#up">up</a></li><li><a href="global.html#updateCompetition">updateCompetition</a></li><li><a href="global.html#updateCountry">updateCountry</a></li><li><a href="global.html#updateLdapUser">updateLdapUser</a></li><li><a href="global.html#updateNotification">updateNotification</a></li><li><a href="global.html#updatePost">updatePost</a></li><li><a href="global.html#updateRegistration">updateRegistration</a></li><li><a href="global.html#updateSelf">updateSelf</a></li><li><a href="global.html#updateSponsor">updateSponsor</a></li><li><a href="global.html#updateStream">updateStream</a></li><li><a href="global.html#updateTeam">updateTeam</a></li><li><a href="global.html#updateTeamMember">updateTeamMember</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#uploadMedia">uploadMedia</a></li><li><a href="global.html#uploadMiddleware">uploadMiddleware</a></li><li><a href="global.html#uploadRobotFile">uploadRobotFile</a></li><li><a href="global.html#useApi">useApi</a></li><li><a href="global.html#useAuth">useAuth</a></li><li><a href="global.html#useAuthContext">useAuthContext</a></li><li><a href="global.html#useCountries">useCountries</a></li><li><a href="global.html#useSocket">useSocket</a></li><li><a href="global.html#useTeams">useTeams</a></li><li><a href="global.html#useToast">useToast</a></li><li><a href="global.html#validatePasswordStrength">validatePasswordStrength</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Mon Jan 12 2026 00:56:59 GMT+0100 (hora est√°ndar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
